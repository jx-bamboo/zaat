<div class="home">
  <%= render "layouts/header" %>
  <div class="container">
    <div class="row text-light fs0875">
      <div class="col-sm-6 px-2">
        <div class="bg_order_card px-3 h-100">
          <div class="fs-4 text-center py-5">Create your 3D Models</div>

          <%= render "order/text_to"%>
            
          <!-- <button type="button" class="eth_pay form-control hover_to_gradient btn btn-lg btn-dark rounded-pill mb-5">Create & Pay</button> -->
          <script src=" https://cdn.jsdelivr.net/npm/web3@4.9.0/dist/web3.min.js "></script>
          
          <script>
      
            var buttonEthConnect = document.querySelector("button.eth_pay");




            if (typeof window.ethereum !== "undefined") {
              console.log("... 安装了metamask...")
              //const chainid = requestChainId();
              //console.log(chainid)

              buttonEthConnect.addEventListener("click", async () => {
                console.log("。。。 点击了按钮 。。。")

                const address = await requestAccounts();
                console.log(address);

                const chainid = await requestChainId();
                console.log(chainid)

                await checkBscNet();



                console.log('...... ......')
                web3 = new Web3(window.ethereum)
                
                const contract_address = "0xeD24FC36d5Ee211Ea25A80239Fb8C4Cfd80f12Ee"
                const contract_abi = [{"constant":false,"inputs":[],"name":"disregardProposeOwner","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"name","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_spender","type":"address"},{"name":"_value","type":"uint256"}],"name":"approve","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"assetProtectionRole","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"totalSupply","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"r","type":"bytes32[]"},{"name":"s","type":"bytes32[]"},{"name":"v","type":"uint8[]"},{"name":"to","type":"address[]"},{"name":"value","type":"uint256[]"},{"name":"fee","type":"uint256[]"},{"name":"seq","type":"uint256[]"},{"name":"deadline","type":"uint256[]"}],"name":"betaDelegatedTransferBatch","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"sig","type":"bytes"},{"name":"to","type":"address"},{"name":"value","type":"uint256"},{"name":"fee","type":"uint256"},{"name":"seq","type":"uint256"},{"name":"deadline","type":"uint256"}],"name":"betaDelegatedTransfer","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_from","type":"address"},{"name":"_to","type":"address"},{"name":"_value","type":"uint256"}],"name":"transferFrom","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[],"name":"initializeDomainSeparator","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"decimals","outputs":[{"name":"","type":"uint8"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[],"name":"unpause","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_addr","type":"address"}],"name":"unfreeze","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[],"name":"claimOwnership","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_newSupplyController","type":"address"}],"name":"setSupplyController","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"paused","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_addr","type":"address"}],"name":"balanceOf","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[],"name":"initialize","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[],"name":"pause","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"getOwner","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"target","type":"address"}],"name":"nextSeqOf","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_newAssetProtectionRole","type":"address"}],"name":"setAssetProtectionRole","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_addr","type":"address"}],"name":"freeze","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"owner","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"symbol","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_newWhitelister","type":"address"}],"name":"setBetaDelegateWhitelister","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_value","type":"uint256"}],"name":"decreaseSupply","outputs":[{"name":"success","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"_addr","type":"address"}],"name":"isWhitelistedBetaDelegate","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_to","type":"address"},{"name":"_value","type":"uint256"}],"name":"transfer","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_addr","type":"address"}],"name":"whitelistBetaDelegate","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_proposedOwner","type":"address"}],"name":"proposeOwner","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_value","type":"uint256"}],"name":"increaseSupply","outputs":[{"name":"success","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"betaDelegateWhitelister","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"proposedOwner","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_addr","type":"address"}],"name":"unwhitelistBetaDelegate","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"_owner","type":"address"},{"name":"_spender","type":"address"}],"name":"allowance","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_addr","type":"address"}],"name":"wipeFrozenAddress","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"EIP712_DOMAIN_HASH","outputs":[{"name":"","type":"bytes32"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_addr","type":"address"}],"name":"isFrozen","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"supplyController","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[],"name":"reclaimBUSD","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"inputs":[],"payable":false,"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"name":"from","type":"address"},{"indexed":true,"name":"to","type":"address"},{"indexed":false,"name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"owner","type":"address"},{"indexed":true,"name":"spender","type":"address"},{"indexed":false,"name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"currentOwner","type":"address"},{"indexed":true,"name":"proposedOwner","type":"address"}],"name":"OwnershipTransferProposed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"oldProposedOwner","type":"address"}],"name":"OwnershipTransferDisregarded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"oldOwner","type":"address"},{"indexed":true,"name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[],"name":"Pause","type":"event"},{"anonymous":false,"inputs":[],"name":"Unpause","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"addr","type":"address"}],"name":"AddressFrozen","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"addr","type":"address"}],"name":"AddressUnfrozen","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"addr","type":"address"}],"name":"FrozenAddressWiped","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"oldAssetProtectionRole","type":"address"},{"indexed":true,"name":"newAssetProtectionRole","type":"address"}],"name":"AssetProtectionRoleSet","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"to","type":"address"},{"indexed":false,"name":"value","type":"uint256"}],"name":"SupplyIncreased","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"from","type":"address"},{"indexed":false,"name":"value","type":"uint256"}],"name":"SupplyDecreased","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"oldSupplyController","type":"address"},{"indexed":true,"name":"newSupplyController","type":"address"}],"name":"SupplyControllerSet","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"from","type":"address"},{"indexed":true,"name":"to","type":"address"},{"indexed":false,"name":"value","type":"uint256"},{"indexed":false,"name":"seq","type":"uint256"},{"indexed":false,"name":"fee","type":"uint256"}],"name":"BetaDelegatedTransfer","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"oldWhitelister","type":"address"},{"indexed":true,"name":"newWhitelister","type":"address"}],"name":"BetaDelegateWhitelisterSet","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"newDelegate","type":"address"}],"name":"BetaDelegateWhitelisted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"oldDelegate","type":"address"}],"name":"BetaDelegateUnwhitelisted","type":"event"}]
                const contract_token = new web3.eth.Contract(contract_abi, contract_address)
                console.log(contract_token)
                

                const to = "0x221b2a964eC6c381EA3c33532130bda1b27FF23b"
                const value = web3.utils.toWei('1','ether')
                const txReceipt = await contract_token.methods.transfer(to,value).send({from: address})
                console.log('Tx hash:',txReceipt.transactionHash)







              });
            } else {
              console.log("... 没有安装 metamask ...")

              buttonEthConnect.innerHTML = "Metamask Not Installed";
              buttonEthConnect.disabled = true;
            }

            async function requestAccounts() {
              const accounts = await ethereum.request({ method: "eth_accounts" });
              return accounts[0];
            }

            async function requestBalance(address) {
              const balance = await ethereum.request({method: "eth_getBalance", params: [address]});
              return parseInt(balance, 16) / Math.pow(10, 18);
            }

            async function requestChainId() {
              console.log("... 进入chainid ...")
              const chainid = await ethereum.request({method: "eth_chainId"});
              return chainid;
            }

            async function checkBscNet() {
              const chainid = await requestChainId();
              if (chainid === '0x61') {
                console.log('用户已连接到 BSC 网络，执行下一步操作 ..')
              } else {
                console.log('用户没有BSC网络xxxxxxx')
                try {
                  console.log("in to try");
                  await ethereum.request({
                      method: 'wallet_addEthereumChain',
                      params: [{
                          chainId: '0x61',
                          chainName: 'BNB Smart Chain Testnet',
                          nativeCurrency: {
                            name: "BNB",
                            symbol: "BNB",
                            decimals: 18,
                          },
                          rpcUrls: ['https://data-seed-prebsc-1-s1.bnbchain.org:8545'],
                          blockExplorerUrls: ['https://testnet.bscscan.com']
                      }]
                  });

                  // console.log('Switch to the BSC network')
                  //await ethereum.request({ method: "wallet_switchEthereumChain", params: [{ chainId: "0x61" }] });
                  // 提示用户已成功添加 BSC 网络
                  console.log('用户已连接到 BSC test 网络 .........................')
                } catch (error) {
                  console.error(error);
                }
              }
            }
            


          </script>
          
        </div>
      </div>

      <div class="col-sm-6 px-2 text-center" style="min-height: 200px;">
        <div class="bg_order_card px-4 h-100 d-flex flex-column justify-content-center my-3 mt-sm-0">

          <% if @my_order_pendding.present? %>
            <div class="my_model h-75 overflow-auto">
              <% @my_order_pendding.each do |order| %>
                <div class="card bg-dark mb-2">
                  <div class="row g-0 bg-dark">

                    <% if order.image.attached? %>
                      <div class="col-md-4 text-md-start">
                        <%= image_tag url_for(order.image.variant(resize_to_fill: [100, 100])), class: "rounded-start", alt: "" %>
                      </div>
                      <div class="col-md-8 text-light">
                        <div class="card-body text-start">
                          <div><span class="badge text-bg-secondary">Pendding</span></div>
                          <% if order.prompt %>
                            <div class="text-truncate"><%= order.prompt %></div>
                          <% end %>
                          <div><small class="text-secondary"><%= time_ago_in_words(order.created_at) %></small></div>
                          <%= display_percentage_progress(order.created_at) %>
                        </div>
                      </div>
                    <% else %>
                      <div class="col-sm-12 text-light">
                        <div class="card-body text-start">
                          <div><span class="badge text-bg-secondary">Pendding</span></div>
                          <% if order.prompt %>
                            <div class="text-truncate"><%= order.prompt %></div>
                          <% end %>
                          <div><small class="text-secondary"><%= time_ago_in_words(order.created_at) %></small></div>
                          <%= display_percentage_progress(order.created_at) %>
                        </div>
                      </div>
                    <% end %>

                  </div>
                </div>
              <% end %>
            </div>

            <div class="mt-3">The process may take up to 3 ~ 5 minutes.</div>
            <div>You can continue waiting or check back later by clicking 'My Models'.</div>
          <% else %>
            <div class="mt-3">The process may take up to 3 ~ 5 minutes.</div>
            <div>You can continue waiting or check back later by clicking 'My Models'.</div>
            <!-- <div class="progress border-0 bg-dark mt-3" role="progressbar" aria-label="dark example" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100">
              <div class="progress-bar bg-dark border-0" style="width: 100%"></div>
            </div> -->
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>
